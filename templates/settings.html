<% include header %>
<style><% include ../assets/css/user-settings.css %></style>

<div class="api-page">
  <main role="main" id="main-content" class="cd-container">
    <div class="cd-layout-content">
      <h1 class="page-header__heading">Settings for <%= user.name %></h1>
      <div class="tabbed">
        <ul>
<!--          <li> -->
<!--            <a href="#section-password">Password</a>-->
<!--          </li>-->
          <li>
            <a href="#section-apps">Authorized Apps</a>
          </li>
<!--          <li>-->
<!--            <a href="#section-security">Security</a>-->
<!--          </li>-->
<!--          <li>-->
<!--            <a href="#section-delete">Delete Account</a>-->
<!--          </li>-->
        </ul>

<!--        <section id="section-password">-->
<!--          <h2>Change Password</h2>-->
<!--          <form onsubmit="changePassword()">-->
<!--              <p>You must enter your current password to set a new password.</p>-->
<!--              <input-->
<!--                id="current-password"-->
<!--                name="password"-->
<!--                type="password"-->
<!--                label="Password"-->
<!--                autocomplete="current-password"-->
<!--                placeholder=" "-->
<!--                outlined-->
<!--                required-->
<!--              />-->
<!--              <p>Passwords must be <strong>at least {{ $v.password.$params.minLength.min }} characters long</strong>, contain at least <strong>one number</strong>, <strong>one uppercase character</strong>, <strong>one lowercase character</strong>, and one <strong>special character: <code>!@#$%^&*()+=\`{}</code></strong>. Password has to be different than your previous one.</p>-->
<!--              <input-->
<!--                id="new-password"-->
<!--                name="password"-->
<!--                type="password"-->
<!--                label="Password"-->
<!--                autocomplete="new-password"-->
<!--                placeholder=" "-->
<!--                outlined-->
<!--                required-->
<!--              />-->
<!--              <input-->
<!--                id="new-password-confirm"-->
<!--                name="passwordConfirm"-->
<!--                type="password"-->
<!--                label="Confirm Password"-->
<!--                autocomplete="new-password"-->
<!--                placeholder=" "-->
<!--                outlined-->
<!--                required-->
<!--              />-->

<!--              <button-->
<!--                id="reset-password"-->
<!--                class="cd-button cd-button--style"-->
<!--                type="submit"-->
<!--              >-->
<!--                Reset Password-->
<!--              </button>-->
<!--          </form>-->
<!--        </section>-->

        <section id="section-apps">
          <h2>Authorized Apps</h2>
          <div class="alert alert--warning alert--inline" role="alert">
            <div class="alert__inner">
              Currently you cannot revoke access to applications.<br>
              Work is in progress to offer this option.
            </div>
          </div>
          <ul>
            <%
              user.authorizedClients.forEach(function(client) {
            %>
            <li>
              <span><%= client.name %></span>
<!--              <button type="button" class="cd-button cd-button--small cd-button--cancel" onclick="removeThisClient(client._id);">-->
<!--                <svg class="cd-icon cd-icon--cancel">-->
<!--                  <use xlink:href="#cd-icon--cancel"></use>-->
<!--                </svg>-->
<!--              </button>-->
            </li>
            <%
            });
            %>
          </ul>
        </section>

<!--        <section id="section-security">-->
<!--          <h2>Two-factor authentication</h2>-->
<!--          <% if (user.totp) { %>-->
<!--          <span class="status" style="color: #777;">Status: <em>Enabled</em></span>-->
<!--          <p>&nbsp;</p>-->
<!--          <button class="cd-button cd-button--style cd-button--dectivate" onclick="goTo('deactivate');">-->
<!--            Deactivate-->
<!--          </button>-->
<!--          <%} else { %>-->
<!--            <span class="status" style="color: #777;">Status: <em>Disabled</em></span>-->
<!--            <p>Two-factor authentication is an effective way to protect your account from unauthorized access. What you need to do to enable this feature:</p>-->
<!--            <ol>-->
<!--              <li>If you don't have one yet, download an authenticator app (e.g. the Google Authenticator - <a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2&hl=en_GB" target="_blank" rel="noopener">Play Store</a>, <a href="https://itunes.apple.com/us/app/google-authenticator/id388497605?mt=8" target="_blank" rel="noopener">App Store</a>).</li>-->
<!--              <li>Then click on the Activate button below</li>-->
<!--              <li>After you have activated the Two-factor verification on this page you will see a QR-code that you need to scan with your authenticator app or you do the set-up manually.</li>-->
<!--              <li>You'll then be sent a code to your mobile authenticator app.</li>-->
<!--            </ol>-->
<!--            <p>Two-factor authentication is an optional security feature. Once enabled, Humanitarian ID will require a six-digit security code or a security key in addition to your password if you wish to login or change your password. You can also set a device as trusted during login, you will then not be asked a seperate code on this device.</p>-->
<!--            <p>After enabling two-factor authentication, you'll receive 16 backup codes. Copy these codes or download them and store them securely. Once a backup code is used, it can't be used again.</p>-->
<!--            <p>You can remove the two-factor authentication at any point by clicking on ‘Deactivate’ button.</p>-->
<!--            <button class="cd-button cd-button--style cd-button--activate" onclick="requestTotpConfig();">-->
<!--              Activate-->
<!--            </button>-->
<!--          <%# Steps to activate should go here #%>-->
<!--          <% } %>-->
<!--        </section>-->

<!--        <section id="section-delete">-->
<!--          <h2>Delete Account</h2>-->
<!--          <button type="button" class="cd-button cd-button--bold cd-button--delete" onclick="deleteAccount();">-->
<!--            Delete-->
<!--          </button>-->
<!--        </section>-->
      </div>
    </div>
  </main>
</div>
<% include footer %>

<script>
  /* https://inclusive-components.design/tabbed-interfaces */
  (function() {
    // Get relevant elements and collections
    const tabbed = document.querySelector('.tabbed');
    const tablist = tabbed.querySelector('ul');
    const tabs = tablist.querySelectorAll('a');
    const panels = tabbed.querySelectorAll('[id^="section"]');

    // The tab switching function
    const switchTab = (oldTab, newTab) => {
      newTab.focus();
      // Make the active tab focusable by the user (Tab key)
      newTab.removeAttribute('tabindex');
      // Set the selected state
      newTab.setAttribute('aria-selected', 'true');
      oldTab.removeAttribute('aria-selected');
      oldTab.setAttribute('tabindex', '-1');
      // Get the indices of the new and old tabs to find the correct
      // tab panels to show and hide
      let index = Array.prototype.indexOf.call(tabs, newTab);
      let oldIndex = Array.prototype.indexOf.call(tabs, oldTab);
      panels[oldIndex].hidden = true;
      panels[index].hidden = false;
    };

    // Add the tablist role to the first <ul> in the .tabbed container
    tablist.setAttribute('role', 'tablist');

    // Add semantics are remove user focusability for each tab
    Array.prototype.forEach.call(tabs, (tab, i) => {
      tab.setAttribute('role', 'tab');
      tab.setAttribute('id', 'tab' + (i + 1));
      tab.setAttribute('tabindex', '-1');
      tab.parentNode.setAttribute('role', 'presentation');

      // Handle clicking of tabs for mouse users
      tab.addEventListener('click', e => {
        e.preventDefault();
        let currentTab = tablist.querySelector('[aria-selected]');
        if (e.currentTarget !== currentTab) {
          switchTab(currentTab, e.currentTarget);
        }
      });

      // Handle keydown events for keyboard users
      tab.addEventListener('keydown', e => {
        // Get the index of the current tab in the tabs node list
        let index = Array.prototype.indexOf.call(tabs, e.currentTarget);
        // Work out which key the user is pressing and
        // Calculate the new tab's index where appropriate
        let dir = e.which === 37 ? index - 1 : e.which === 39 ? index + 1 : e.which === 40 ? 'down' : null;
        if (dir !== null) {
          e.preventDefault();
          // If the down key is pressed, move focus to the open panel,
          // otherwise switch to the adjacent tab
          dir === 'down' ? panels[i].focus() : tabs[dir] ? switchTab(e.currentTarget, tabs[dir]) : void 0;
        }
      });
    });

    // Add tab panel semantics and hide them all
    Array.prototype.forEach.call(panels, (panel, i) => {
      panel.setAttribute('role', 'tabpanel');
      panel.setAttribute('tabindex', '-1');
      let id = panel.getAttribute('id');
      panel.setAttribute('aria-labelledby', tabs[i].id);
      panel.hidden = true;
    });

    // Initially activate the first tab and reveal the first tab panel
    tabs[0].removeAttribute('tabindex');
    tabs[0].setAttribute('aria-selected', 'true');
    panels[0].hidden = false;
  })();


  // function sortedClients() {
  //   const sorted = this.profile.authorizedClients;
  //   return sorted.sort((a, b) => a.name.localeCompare(b.name));
  // }

  // function asyncData({ route, app: { $hid } }) {
  //   // URL pattern: /settings/:slug
  //   const currentTab = '/settings/clients';
  //
  //   // Get latest user account data.
  //   const profile = await $hid.$get('/account.json');
  //
  //   return {
  //     profile,
  //     currentTab,
  //   };
  // }

  // function removeThisClient(idToBeRemoved) {
  //   // Isolate client to be removed so we can prompt user for confirmation.
  //   const clientToBeRemoved = this.profile.authorizedClients.filter(client => client._id === idToBeRemoved).pop();
  //   const removalMessage = `Are you sure you want to remove ${clientToBeRemoved.name}? You will need to authorize the application again to access it through Humanitarian ID.`;
  //
  //   // Prompt user to confirm removal.
  //   const userConfirmedRemoval = await this.$confirm(removalMessage);
  //
  //   // If they confirmed, then proceed with removal.
  //   if (userConfirmedRemoval) {
  //     // Remove client from the user's profile
  //     const remainingClients = this.profile.authorizedClients.filter(client => client._id !== idToBeRemoved);
  //     this.profile.authorizedClients = remainingClients;
  //
  //     // Update HID API
  //     this.$hid.$put(`/api/v2/user/${this.me}`, this.profile);
  //   }
  // }


  function deleteAccount(totpToken) {
    // This value should only last as long as the function executes.
    let confirmed = false;

    window.confirm('Are you sure you want to do this? You will not be able to access Humanitarian ID anymore.');

    // // We don't want to show the confirmation prompt while asking for TOTP so
    // // we store the result temporariliy. If the user closes TotpPrompt without
    // // submitting, we'll wipe this value so that a second attempt to delete
    // // will require new confirmation.
    // if (!this.alreadyConfirmed) {
    //   confirmed = await this.$confirm('Are you sure you want to delete your Humanitarian ID account? You will no longer be able to access any of the HID-integrated platforms.');
    // }
    //
    // // If the user confirmed, or if TOTP is required (alreadyConfirmed)
    // if (confirmed || this.alreadyConfirmed) {
    //   this.alreadyConfirmed = true;
    //   this.pending = true;
    //
    //   // Ensure that we only send a fresh TOTP by setting to null and only
    //   // adding when the value is sent by the TotpPrompt emitted event.
    //   //
    //   // Note: totpToken is the raw event when submitting without TOTP so we
    //   // have an extra type check to ensure we're not sending garbage.
    //   this.$hid.setHeader('X-HID-TOTP', null);
    //   if (typeof totpToken === 'string' && totpToken !== '') {
    //     this.$hid.setHeader('X-HID-TOTP', totpToken);
    //   }
    //
    //   // Ask HID to delete this user account.
    //   this.$hid.$delete(`/api/v2/user/${this.me}`)
    //     .then((res) => {
    //       this.message = 'Your account was successfully removed. You are now logged out. Sorry to have you go.';
    //       this.displayMessage = true;
    //       this.resetTotpPrompt();
    //       this.logout();
    //     })
    //     .catch((err) => {
    //       if (err.response && err.response.data && err.response.data.message && err.response.data.message === 'No TOTP token') {
    //         this.needsTotp = true;
    //       } else if (err.response && err.response.data && err.response.data.message && this.totpInvalid.includes(err.response.data.message)) {
    //         this.needsTotp = true;
    //         this.message = 'Your authentication token was invalid. Please try again.';
    //         this.error = true;
    //         this.displayMessage = true;
    //       } else if (err.response && err.response.data && err.response.data.message) {
    //         this.message = err.response.data.message;
    //         this.error = true;
    //         this.displayMessage = true;
    //       } else {
    //         this.message = err;
    //         this.error = true;
    //         this.displayMessage = true;
    //       }
    //     })
    //     .finally(() => {
    //       this.pending = false;
    //     });
    // }
  }

  // function resetTotpPrompt() {
  //   this.needsTotp = false;
  //   this.alreadyConfirmed = false;
  // }

</script>
